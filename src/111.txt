async function fetchAndStoreData(storeName, key, url) {
  const storedData = await getData(storeName, key);
  const lastModified = storedData ? storedData.lastModified : null;

  try {
    const response = await fetch(url, {
      headers: lastModified ? { 'If-Modified-Since': lastModified } : {}
    });

    if (response.status === 200) {
      const data = await response.json();
      const newLastModified = response.headers.get('Last-Modified');
      await saveData(storeName, key, data, newLastModified);
      return data;
    } else if (response.status === 304 && storedData) {
      return storedData.data;
    } else if (storedData) {
      return storedData.data;
    } else {
      throw new Error('Failed to load data');
    }
  } catch (error) {
    console.error('Failed to fetch data, falling back to IndexedDB:', error);
    if (storedData) {
      return storedData.data;
    } else {
      throw new Error('No data available in IndexedDB');
    }
  }
}